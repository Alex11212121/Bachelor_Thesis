---
title: "Annexe 2"
author: "Alexandre Kobrin - Bachelor Thesis"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
subtitle: Documentation of Analysis in R
---

## Loading packages and data

```{r, echo=FALSE, warnings= FALSE, results = "hide" }

#Setting up path to file
setwd("/Users/alexandre/Desktop/Big-project/Data-uni/Data analysis")

# loading the packages
library(tidyverse)
library(car)
library(knitr)
library(glmnet)
library(performance)
library(ggplot2)
library(dplyr)


# reading the data using read.csv() method
rent_data <- read.csv('rents_S3_Done.csv')
```

## Preparing data for regression

```{r, warnings= FALSE}

#Assigning the different numerical values to their categories 
rent_data <- rent_data %>%
  mutate(
    a_sicht = case_when(
      a_sicht == 0 ~ 'no_view',
      a_sicht == 1 ~ 'in_general',
      a_sicht == 2 ~ 'to_the_mountains',
      a_sicht == 3 ~ 'on_the_lake',
      a_sicht == 4 ~ 'Mountains_and_lake',
      a_sicht == 5 ~ 'Not_lake_and_mountain'),
    a_balkon = case_when(a_balkon == 1 ~ 'no balcony',
                         a_balkon == 2 ~ 'general',
                         a_balkon == 3 ~ 'small balcony',
                         a_balkon == 4 ~ 'big balcony',
                         a_balkon == 5 ~ 'terasse',
                         a_balkon == 6 ~ 'roof terasse'),
    region = case_when(region == 0 ~ 'german',
                       region == 1 ~ 'french',
                       region == 2 ~ 'italian')
  )

#convert all character variables to factors
rent_data <- rent_data %>%
  mutate_if(is.character, as.factor)

#set as an ordered factor variable
sort(unique(rent_data$a_nb_rooms))
#rent_data$a_nb_rooms<-factor(rent_data$a_nb_rooms,levels =c(sort(unique(rent_data$a_nb_rooms))),ordered = T )
rent_data$a_nb_rooms<-as.character(rent_data$a_nb_rooms)
unique(rent_data$a_nb_rooms)
glimpse(rent_data)

```

## Model 1

Building multiple linear regression model with all the variables included but no interaction term.

```{r}
options(scipen = 999)
no_interaction_model <- lm(a_netm_mon ~ a_surface_living + age + a_sicht + a_balkon + region + a_zip_2 + a_nb_rooms , data=rent_data)
# summary() of the model fit
summary(no_interaction_model)

```

Variance Inflation Factor test on model 1.

```{r}
#VIF test, if there is any value that has a greater value then 5 we should remove it. Here there are non.
vif(no_interaction_model)
```

## Checking for Interactions

Interaction between Living Surface and Region

```{r,warnings= FALSE, message=FALSE}
ggplot(data = rent_data, aes(x = a_surface_living, y = a_netm_mon, color = region)) +
  geom_smooth(method = 'lm', se = FALSE, aes(linetype = region), size = 1.2) +
  scale_color_manual(values = c("black", "black", "black")) +
  scale_linetype_manual(values = c("solid", "dashed", "dotted")) +
  theme_classic() +
  guides(linetype = FALSE)


```

Interaction between number of rooms and Region

```{r,fig.width=15, fig.height=10, warnings= FALSE, message=FALSE}
interaction.plot(x.factor = rent_data$region,
                 trace.factor = rent_data$a_nb_rooms,
                 response = rent_data$a_netm_mon, fun = mean,
                 col = ifelse(rent_data$a_nb_rooms == 1, "black", "black"),
                 lwd = 1.2, lty = 1:3, type = "b",
                 xlab = "Region", ylab = "Monthly Net Rent")

```

Interaction between view and Region

```{r, fig.width=15, fig.height=10}
interaction.plot(x.factor = rent_data$region,
                 trace.factor = rent_data$a_sicht,
                 response = rent_data$a_netm_mon, fun = mean)

```

Interaction between Balcony and Region

```{r,fig.width=15, fig.height=10}
interaction.plot(x.factor = rent_data$region,
                 trace.factor = rent_data$a_balkon,
                 response = rent_data$a_netm_mon, fun = mean)

#Extraction of exact values since interaction seems small
x<-rent_data %>% 
  group_by(region,a_balkon) %>% 
  summarise(a_netm_mon=mean(a_netm_mon,na.rm=T))
kable(x, format = "markdown")
```

## Model 1.2

Building multiple linear regression model with all the variables and relevant interaction term.

```{r}
options(scipen = 999)
interaction_model <- lm(a_netm_mon ~ a_surface_living + age + a_sicht + a_balkon + region + a_zip_2 + a_nb_rooms + region:a_surface_living + region:a_nb_rooms + region:a_sicht + region:a_balkon, data=rent_data)
# summary() of the model fit
summary(interaction_model)

```

## Verifying regression assumptions

```{r}
#Linearity Assumption
plot(interaction_model,1)

#Normality Assumption
plot(interaction_model,2)

#Homoscedascity
plot(interaction_model,3)

#Influencial Outliers
plot(interaction_model,5)

y<-cooks.distance(interaction_model)

summary(y)

```

Appending prediction to original data frame.

```{r}
rents_preditions = rent_data %>%
  mutate(predictions = predict(interaction_model, newdata = rent_data))
```

## Model 1.3

Building multiple linear regression model with all the variables and relevant interaction term and variables transformation.

```{r}
options(scipen = 999)
interaction_model_v2 <- lm(a_netm_mon ~ log(a_surface_living) + age^2 + a_sicht + a_balkon + region + a_zip_2 + a_nb_rooms + region:a_nb_rooms + region:a_sicht + region:a_balkon, data=rent_data)
# summary() of the model fit
summary(interaction_model_v2)

# Calculate RMSE
predicted <- predict(interaction_model_v2)
actual <- rent_data$a_netm_mon
rmse <- sqrt(mean((predicted - actual)^2))
print(rmse)
```

## Verifying regression assumptions (2)

```{r}
#Linearity Assumption
plot(interaction_model_v2,1)

#Normality Assumption
plot(interaction_model_v2,2)

#Homoscedascity
plot(interaction_model_v2,3)

#Influencial Outliers
plot(interaction_model_v2,5)

y<-cooks.distance(interaction_model_v2)

summary(y)
```

## Model 2

Stepwise regression model

```{r}
model.step<-step(interaction_model_v2,direction = "backward")

summary(model.step)

```

The stepwise approach is not producing significant results; it is choosing the model with the highest AIC, which is inadequate given that assumptions are partially violated. In the linear regression, there are high standard errors, meaning that variables influence each other a lot. We chose ridge regression because it reduces the variance of specific values by minimizing the standard deviation.

```{r}
#Looking at the number of observation for each number of rooms
rent_data %>%
  count(a_nb_rooms)

```

## Model 3

Building a ridge regression model

```{r}
#Adding variables
formula <- a_netm_mon ~ a_surface_living + age^2 + a_sicht + a_balkon + region + a_zip_2 + a_nb_rooms + region:a_sicht + region:a_balkon + region:a_surface_living + region:a_nb_rooms

#creating a model matrix, it can be used to predict our variable y
X <- model.matrix(formula, data = rent_data)
Y <- rent_data$a_netm_mon

#We can see that they are all numeric
#View(X)

ridge_model<-glmnet(X, Y,alpha = 0)
summary(ridge_model)

#performing cross validation, 10 fold by default
#Y axis we have the mean square error, we want to reduce it, to achieve that goal we try different cross validation. The graph tells us for which value of lambda the mean square value will be minimum. the whole process shows the robustness of the fitted model, getting a more optimal model.
cv_model<-cv.glmnet(X, Y,alpha = 0)
plot(cv_model)

cv_model$lambda.min
#--
# Get the range of lambda values within one standard error of the minimum
lambda_range <- cv_model$lambda.1se

# Check the range of lambda values
print(cv_model$lambda.1se)
print("sep")
print(cv_model$lambda.min)
#--
#Setting lamda in the model
fitted_ridge_model<-glmnet(X, Y,alpha = 0,lambda = cv_model$lambda.min)

#Significance is irellevant in ridge and lasso regressions
coef(fitted_ridge_model)

Ypred <- predict(fitted_ridge_model, newx = X)

#RMSE function gives us the R squared value
data.frame(
  RMSE = caret::RMSE(Ypred, Y),
  Rsquare = caret::R2(Ypred, Y)
)


```

## Visualization of interaction effects

Visualization of the effect of region on the view.

```{r}


# New coefficients
coeff <- c(79.71247172,   # German region - View mountain and lake
           -149.00641702, # Italian region - View on mountain and lake
           
           41.85707441,   # German region - Not mountain and lake
           244.08438452,  # Italian region - Not mountain and lake
           
           59.25632239,   # German region - View on the lake
           -35.45954432,  # Italian region - View on the lake
           
           16.84030441,   # German region - View on the mountains
           -17.65423335,  # Italian region - View on the mountains
           
           -42.18799564,  # German region - No view
           0             # Italian region - No view NO DATA
)


Variable <- c("German region - View mountain and lake",
           "Italian region - View on mountain and lake",
           
           "German region - Not mountain and lake",
           "Italian region - Not mountain and lake",
           
           "German region - View on the lake",
           "Italian region - View on the lake",
           
           "German region - View on the mountains",
           "Italian region - View on the mountains",
           
           "German region - No view",
           "Italian region - No view NO DATA"
)
dt<-data.frame(Variable,coeff)

dt %>% 
  mutate(Variable = factor(Variable, levels = Variable)) %>%
  ggplot(aes(x = Variable, y = coeff)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip()
```

Visualization of the effect of region on balconies.

```{r}
# New coefficients
coeff <- c(-54.32933246,  # German region - General balcony
           18.64326524,    # Italian region - General balcony
           
           -84.69514471,  # German region - No balcony
           -46.81002035,  # Italian region - No balcony
           
           142.33423192,  # German region - Roof terasse
           0,             # Italian region - Roof terasse NO DATA
           
           -141.21265746, # German region - Small balcony
           -31.49585161,  # Italian region - Small balcony
           
           30.53911500,   # German region - Terasse balcony
           -177.38708251  # Italian region - Terasse balcony
)

Variable <- c("German region - General balcony",
           "Italian region - General balcony",
           
           "German region - No balcony",
           "Italian region - No balcony",
           
           "German region - Roof terasse",
           "Italian region - Roof terasse NO DATA",
           
           "German region - Small balcony",
           "Italian region - Small balcony",
           
           "German region - Terasse balcony",
           "Italian region - Terasse balcony"
)


dt<-data.frame(Variable,coeff)

dt %>% 
  mutate(Variable = factor(Variable, levels = Variable)) %>%
  ggplot(aes(x = Variable, y = coeff)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip()
```

Visualization of the effect of region on the different number of rooms.

```{r}
region_german <- list(
  a_nb_rooms1.5 = -18.04104846,
  a_nb_rooms2 = 39.91837853,
  a_nb_rooms2.5 = 18.69740652,
  a_nb_rooms3 = 69.36917260,
  a_nb_rooms3.5 = 53.95684101,
  a_nb_rooms4 = -17.63230318,
  a_nb_rooms4.5 = 18.68479995,
  a_nb_rooms5 = -138.78606596,
  a_nb_rooms5.5 = 29.07399130,
  a_nb_rooms6 = -182.54481911,
  a_nb_rooms6.5 = -49.87134812,
  a_nb_rooms7 = -113.40930353,
  a_nb_rooms7.5 = -172.94051518,
  a_nb_rooms8 = -229.88216094,
  a_nb_rooms8.5 = -83.89383802,
  a_nb_rooms9 = -455.02334303,
  a_nb_rooms9.5 = -262.45304309,
  a_nb_rooms10 = -28.39277656,
  a_nb_rooms10.5 = -174.10418608,
  a_nb_rooms14 = -340.84433506
)


# Convert the list to a data frame
region_german_df <- data.frame(
  nb_rooms = c(1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 14),
  values = unlist(region_german)
)

# Create the bar chart
barplot(region_german_df$values, names.arg = region_german_df$nb_rooms,
        xlab = "Number of rooms", ylab = "Coefficient", main = "Region German")

```

```{r}
region_italian <- list(
  a_nb_rooms1.5 = -189.89794534,
  a_nb_rooms2 = -180.26305300,
  a_nb_rooms2.5 = -163.32157242,
  a_nb_rooms3 = -121.21181098,
  a_nb_rooms3.5 = -5.22542841,
  a_nb_rooms4 = -175.52563061,
  a_nb_rooms4.5 = -86.40777702,
  a_nb_rooms5 = -207.98935279,
  a_nb_rooms5.5 = 33.17914752,
  a_nb_rooms6 = -92.96356182,
  a_nb_rooms6.5 = -142.55522418,
  a_nb_rooms7 = -361.22856514,
  a_nb_rooms7.5 = -167.12975470,
  a_nb_rooms8 = 0,
  a_nb_rooms8.5 = 225.72429608,
  a_nb_rooms9 = -680.29577497,
  a_nb_rooms9.5 = 0,
  a_nb_rooms10 = 0,
  a_nb_rooms10.5 = 0,
  a_nb_rooms14 = 0
)

# Convert the list to a data frame
region_italian_df <- data.frame(
  nb_rooms = c(1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 14),
  values = unlist(region_italian)
)

# Create the bar chart
barplot(region_italian_df$values, names.arg = region_italian_df$nb_rooms,
        xlab = "Number of rooms", ylab = "Coefficient", main = "Region Italian")

```
